<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="main">

<th:block layout:fragment="content">
	<div id="wrapper">


		<!-- Content Wrapper -->
		<div id="content-wrapper" class="d-flex flex-column">
			<!-- Begin Page Content -->
			<div class="container-fluid">
				<div class="card shadow mb-4" id = "surveypage">
					<th:block th:if="${formList !=null}">
					<div class="card-header py-3" >
						<h6 class="m-0 font-weight-bold text-primary">
							자가진단테스트<span th:text="${category_title}"></span>
						</h6>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-bordered" id="surveyTable">
								<thead>
									<tr>
										<th class="text-center" rowspan="2">No</th>
										<th class="text-center" rowspan="2">평가기술</th>
										<th class="d-none" rowspan="2">Category</th>
										<th width="11%" class="text-center">전혀 <br />그렇지 않다
										</th>
										<th width="11%" class="text-center">그렇지 않다</th>
										<th width="11%" class="text-center">보통이다</th>
										<th width="11%" class="text-center">그렇다</th>
										<th width="11%" class="text-center">매우 그렇다</th>
									</tr>
									<tr>
										<th width="11%" class="text-center">0</th>
										<th width="11%" class="text-center">1</th>
										<th width="11%" class="text-center">2</th>
										<th width="11%" class="text-center">3</th>
										<th width="11%" class="text-center">4</th>
									</tr>
								</thead>
								<tbody id="surveyTable_tbody">
									<tr th:each="item : ${formList}">
										<td class="text-center" th:text="${itemStat.count}"></td>
 										<td th:text="${item.content}"></td>
										<td th:text="${item.category}" style="display: none"></td>
										<td class="text-center"><input type="radio"
											th:name="${item.id}" value="0" /><label for="default-radio"></label></td>
										<td class="text-center"><input type="radio"
											th:name="${item.id}" value="1" /><label for="default-radio"></label></td>
										<td class="text-center"><input type="radio"
											th:name="${item.id}" value="2"  /><label
											for="default-radio"></label></td>
										<td class="text-center"><input type="radio"
											th:name="${item.id}" value="3" /><label for="default-radio"></label></td>
										<td class="text-center"><input type="radio"
											th:name="${item.id}" value="4" /><label for="default-radio"></label></td> 
									</tr>
								</tbody>
							</table>
						</div>
						<a href="#" class="btn btn-success btn-icon-split"
							onclick="fn_onclick_btn_submit()"> <span
							class="icon text-white-50"> <i class="fas fa-check"></i>
						</span> <span class="text">다 음</span>
						</a> 
						
					</div>
				</th:block>
				</div>
				
			</div>
			<!-- End of Main Content -->

		</div>
		<!-- End of Content Wrapper -->

	</div>
	<!-- End of Page Wrapper -->

	<!-- Scroll to Top Button-->
	<a class="scroll-to-top rounded" href="#page-top"> <i
		class="fas fa-angle-up"></i>
	</a>
</th:block>
<th:block layout:fragment="script">
	<script type="text/javascript" th:inline="javascript">
	var pageCnt = 10;
	var pageNo  = 1; 
	var survey_result = []; 
	var index = 0; 
	var categoryList = {};
	
	/*
	* 화면 초최로드시 실행
	*/
	$(document).ready(function(){
    	console.log("page load"); 
    	categoryList  = [[${categoryList}]];
    	console.log(categoryList);
    	
    	fn_getSurveyList(categoryList[index].id, categoryList[index].title, categoryList.length );
	});
	
	/*
	*  자가진단 리스트 조회 함수 
	*/
	function fn_getSurveyList(category_id, category_title) {
		
		var param = {
				"category_id" : category_id,
				"category_title" : category_title,
				"category_Totcnt" : categoryList.length,
				"category_num"  : index+1 }; 
		
		$.ajax({
	        type: "POST",
	        url: "surveyList",
	        data: JSON.stringify(param),  
	        contentType:'application/json; charset=UTF-8',
	        success: function(data) {
	            console.log("AJAX SUCCESS");
	            
	            // 통신 후 화면 매핑 
	            $("#surveypage").replaceWith(data);
	        },
	        error : function(request, status, error){
	            console.log("AJAX_ERROR");
	            console.log("code = "+ request.status + " error = " + error); // 실패 시 처리
	        }
	    });  
		
	};
	
	/*
	*  자가진단 결과저장 함수  
	*/
	function fn_submit_result() {
		console.log(survey_result);
		var param = { 
			"result" :JSON.stringify(survey_result)
		}; 
		
		
		$.ajax({
	        type: "POST",
	        url: "submit",
	        data: JSON.stringify(param),  
	        contentType:'application/json; charset=UTF-8',
	        success: function(data) {
	            console.log("AJAX SUCCESS");
				location.href = "/";	            
	        },
	        error : function(request, status, error){
	            console.log("AJAX_ERROR");
	            console.log("code = "+ request.status + " error = " + error); // 실패 시 처리
	        }
	    });  
	}	
	/*
	*  다음 버튼 클릭 이벤트 
	*/
	function fn_onclick_btn_submit() {
		console.log("btn onclick"); 
		
		/*			var formStr  = /!*[[${formList}]]*!/;
					var formList = JSON.parse(formStr);*/

		var formList = /*[[${formList}]]*/;
		var isPassed = true;
		var score = 0; 
					
		$(formList).each(function(index, form){
			if ( $('input:radio[name = '+ formList[index].id +']').is(":checked") == false) {
				alert(formList[index].id+ "번이 선택되지 않았습니다. ");
				isPassed = false;
				return;
			}

			form.score = $('input:radio[name = '+ form.id +']:checked').val();
			if(typeof form.score !="undefined") {
			 	score += Number(form.score); 	
			}
		});

		
		survey_result.push({"id" : categoryList[index].id, "score" : score});
		index++; 
        
        console.log(categoryList,score, index, survey_result);	
        if(categoryList.length == index) {
        	fn_submit_result();
        } else {
        	fn_getSurveyList(categoryList[index].id, categoryList[index].title);
        }
        
	};

 
	</script>
</th:block>
</html>
