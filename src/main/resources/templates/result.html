<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="main">
<th:block layout:fragment="content">

<!-- Page Wrapper -->
<div id="wrapper">
    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
            <!-- Begin Page Content -->
            <div class="container-fluid">

                <!-- Page Heading -->
                <div class="d-sm-flex align-items-center justify-content-between mb-2">
                    <h1 class="h3 text-gray-800"><span th:text="${result[0].user_id}"></span>님의 PT역량 결과입니다.</h1>
                </div>

                <div th:if='${"".equals(result[0].data[0].workDtim)}'>
                    검사결과가 없습니다.
                </div>
                <div th:unless='${"".equals(result[0].data[0].workDtim)}'>
                    <div class="row mb-3">
                        <div class="col-md-12 col-lg-6">
                            <!-- Rader Chart -->
                            <div class="card shadow mb-4 h-100">
                                <div class="card-header py-3">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="dropdown">
                                                <button class="btn btn-primary btn-block dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <span id="current-workDtim"></span>
                                                </button>
                                                <div class="dropdown-menu w-100" aria-labelledby="dropdownMenuButton">
                                                    <!--<a class="dropdown-item" href="#">Action</a>
                                                    <a class="dropdown-item" href="#">Another action</a>
                                                    <a class="dropdown-item" href="#">Something else here</a>-->
                                                    <div th:each="data : ${result[0].data}">
                                                        <a class="text-center dropdown-item dropdown-workDtim" th:text="${data.workDtim}"></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body mb-4">
                                    <div class="chart-bar">
                                        <canvas id="mainChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 col-lg-6">
                            <!-- Horizontal Bar Chart -->
                            <div class="card shadow mb-4 h-100">
                                <div class="card-header py-3">
                                    <div class="row">
                                        <div class="col-12">
                                            <h6 class="font-weight-bold text-primary">점검결과</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body mb-4">
                                    <div th:each="title : ${result[0].data[0].title}">
                                        <div class="row">
                                            <div class="col-12">
                                                <div>
                                                    <canvas th:attr="id=|barChart_${title}|" height="37"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card shadow h-100">
                                <div class="card-header py-3">
                                    <div class="row">
                                        <div class="col-12">
                                            <h6 class="font-weight-bold text-primary">교육과정</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body mb-4">
                                    <div class="table-responsive">
                                        <table class="table" width="100%" cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th>등급</th>
                                                    <th>교육과정</th>
                                                    <th>비고</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr id="edu_begin">
                                                    <td>초, 중급</td>
                                                    <td>PT 기초 입문</td>
                                                    <td>PT 공통 및 기본 사항</td>
                                                </tr>
                                                <tr id="edu_expert">
                                                    <td>고급</td>
                                                    <td>PT 발표 전문가 양성 과정</td>
                                                    <td>숙련자가 되기 위해 놓치지 말아야 할 내용 기술</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- End of Main Content -->
    </div>
    <!-- End of Content Wrapper -->
</div>
<!-- End of Page Wrapper -->
</th:block>

<th:block layout:fragment="script">
    <script type="text/javascript" th:inline="javascript">
        var resultSet = /*[[${result}]]*/;
        var radarChart;
        var barCharts;

        /**
         * 처음 페이지 초기화
         */
        $(document).ready(function(){
            console.log(resultSet);

            if (resultSet[0].data[0].workDtim != "") {
                $('.dropdown-workDtim:first').trigger('click');
            }
        });

        /**
         * Button Event
         *
         * .dropdown-workDtim.click
         */
        $('.dropdown-workDtim').click(function(){
            var targetWorkDtim = $(this).text();

            var targetWorkDtimTitle     = findValue(targetWorkDtim, 'title');
            var targetWorkDtimScore     = findValue(targetWorkDtim, 'score');
            var targetWorkDtimDetail    = findValue(targetWorkDtim, 'detail');
            var targetWorkDtimDesc      = findValue(targetWorkDtim, 'description');

            /*
             * dropdown 현행화
             */
            $('#current-workDtim').text(targetWorkDtim);

            /*
             * 차트 제거
             */
            if (radarChart != null) {
                radarChart.destroy();
            }

            if (barCharts != null) {
                $(barCharts).each(function(index, barChart){
                    barChart.destroy();
                });
            }

            /*
             * 차트 현행화
             */
            radarChart = createRadarChart(targetWorkDtimTitle
                , targetWorkDtimScore
                , targetWorkDtimDetail
                , targetWorkDtimDesc);
            barCharts = [];

            $(targetWorkDtimTitle).each(function(index) {
                barCharts.push(createHorizontalBarChart(targetWorkDtimTitle[index]
                    , targetWorkDtimScore[index]
                    , targetWorkDtimDetail[index]
                    , targetWorkDtimDesc[index]));
            });

            /*
             * 교육과정 현행화
             */
            setEduLevel(targetWorkDtimTitle);
        });

        /**
         * setEduLevel
         */
        function setEduLevel(titles) {
            var isBeginner = true;

            $(titles).each(function(index, title){
                if (title.indexOf('필요') == -1) {
                    isBeginner = false;
                    return;
                }
            });

            if (isBeginner) {
                $('#edu_begin').addClass('table-success');
                $('#edu_expert').removeClass('table-success');
            } else {
                $('#edu_begin').removeClass('table-success');
                $('#edu_expert').addClass('table-success');
            }
        }

        /**
         * Utils
         *
         * findValue
         */
        function findValue(workDtim, keyParam) {
            var value;

            $(resultSet[0].data).each(function(index, data){
                if (data.workDtim == workDtim) {
                    value = data[keyParam];
                    return;
                }
            });

            return value;
        }

        /**
         * createCharts
         *
         * createRaderChart
         * createHorizontalBarChart
         */
        function createRadarChart(title, score, detail, description) {
            var chart = new Chart($('#mainChart'), {
                type    : 'radar',
                data    : {
                    labels : title,
                    datasets : [{
                        backgroundColor : 'rgba(255, 99, 132, 0.5)',
                        pointRadius : 5,
                        pointHoverRadius : 7,
                        data : score
                    }]
                },
                options : {
                    legend : {
                        display : false
                    },
                    scale : {
                        ticks : {
                            beginAtZero : true,
                            min : 0,
                            max : 100,
                            stepSize : 20
                        }
                    },
                    tooltips : {
                        callbacks : {
                            title : function(tooltipItem, data) {
                                return data['datasets'][0]['data'][tooltipItem[0]['index']] +
                                    "점 : " +
                                    detail[tooltipItem[0]['index']];
                            },
                            label : function (tooltipItem, data) {
                                return description[tooltipItem['index']];
                            }
                        }
                    }
                }
            });

            return chart;
        }

        function createHorizontalBarChart(title, score, detail, description) {
            var chart = new Chart($('#barChart_' + title), {
                type : 'horizontalBar',
                data : {
                    labels : [title],
                    datasets : [{
                        fill : false,
                        backgroundColor : ['rgba(255, 99, 132, 0.5)'],
                        borderColor : ['rgb(255, 159, 64)'],
                        data : [score]
                    }]
                },
                options : {
                    legend : {
                        display : false
                    },
                    scales : {
                        xAxes : [{
                            ticks : {
                                beginAtZero : true,
                                min : 0,
                                max : 100,
                                stepSize : 20
                            }
                        }],
                        yAxes : [{
                            afterFit: function(scaleInstance) {
                                scaleInstance.width = 125; // sets the width to 100px
                            }
                        }]
                    },
                    tooltips : {
                        callbacks : {
                            title : function(tooltipItem, data) {
                                return data['datasets'][0]['data'][tooltipItem[0]['index']] +
                                    "점 : " +
                                    detail;
                            },
                            label : function (tooltipItem, data) {
                                return description;
                            }
                        }
                    }
                }
            });

            return chart;
        }
    </script>
</th:block>
</html>
